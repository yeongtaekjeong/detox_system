{% extends "index_base.html" %}

{% block contents %}
{% load static %}
<link href="{% static 'detoxapp/css/prescription.css' %}" rel="stylesheet">
    <!-- Page content-->
    <section>
        <div class="container px-5">
            <!-- Contact form-->
            <div class="bg-light rounded-4 py-5 px-md-5 main-box ">
                <div id="printnotarea1">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <h2 class="fw-bolder mb-2"><span class="text-gradient d-inline">처방 결과</span></h2>
                        <!-- Download resume button-->
                        <!-- Note: Set the link href target to a PDF file within your project-->
                        <div class="d-flex justify-content-end mb-0">    
                            <button class="btn btn-primary px-4 py-1 justify-content-end" id="printbtn">
                                <div class="d-inline-block bi bi-download me-2"></div>
                                결과 프린트
                            </button>
                        </div>
                    </div>
                </div>
            
                <!--메인 DIV-->
                <div class="row align-items-center justify-content-center" id="printarea" style="margin:0">
                    <ul class="nav nav-tabs" id="tab-menu">
                        <li class="nav-item" role="button">
                            <p class="nav-link active" id="tab_1" aria-current="page" onclick="tabno(1)">AI 처방 결과</p>
                        </li>
                        <li class="nav-item" role="button">
                            <p class="nav-link" id="tab_2" onclick="tabno(2)">문진 내용</p>
                        </li>
                        <!-- <li class="nav-item" role="button">
                            <p class="nav-link" id="tab_3" onclick="tabno(3)">문진내용</p>
                        </li> -->
                    </ul>
                    <p></p>
                    <div class="col-sm-12" style="padding: 10px;">
                        <table>
                            <h2 class="fw-bolder mb-1" id="hidden_title" hidden>우주연 한의원 처방 결과</h2>
                            <p class="fw-bolder p-1 mb-1" style="font-size: 1em;">검사일시 : {{first_tab.update_date|date:"Y.m.d H:i:s"}}</p>
                            <tr>
                                <td class="tg" style="background-color:gray"><h6 class="fw-bolder p-1 mb-1 text-white">이름</h6></td>
                                <td class="tg text-dark p-1 mb-3" id="name">{{ first_tab.user_name }}</td>
                                <td class="tg" style="background-color:gray"><h6 class="fw-bolder p-1 mb-1 text-white">나이</h6></td>
                                <td class="tg text-dark p-1 mb-3" id="data1_3">{{ first_tab.user_birth }}세</td>
                                <td class="tg" style="background-color:gray"><h6 class="fw-bolder p-1 mb-1 text-white">성별</h6></td>
                                <td class="tg text-dark p-1 mb-3" id="data1_2">{% if first_tab.user_gender == 0 %}남{% else %}여{% endif %}자</td>
                            </tr>
                        </table>
                    </div>    
                    <p></p>
                    <div id="tabcontent_1">
                        <!--처방표-->
                        {% csrf_token %}
                        {% include "detoxapp/prescription/prescription_1.html" %}
                    </div>
                    <div id="tabcontent_2" hidden>
                        <!--문진표-->
                        {% csrf_token %}
                        {% include "detoxapp/prescription/prescription_2.html" %}
                    </div>
                </div>
                <div id="printnotarea2">
                    <div class="d-flex justify-content-center mb-0"> 
                        <button class="btn btn-outline-success px-4 py-1 justify-content-end" id="prescription_complete_btn">
                            처방 종료
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>
<script>

$(document).ready(function(){
    google.charts.load('current', {packages: ['corechart', 'bar']});
    google.charts.setOnLoadCallback(drawAxisTickColors);
    get_result_info()
    life_style_recommend()
})


// 탭 and 탭 내용 전환
    function tabno(n) {
        let postdata = {
            'no': n
        };

        $.ajax({
            type: 'post', // 타입 (get, post, put 등등)
            url: '/prescription_result/', // 요청할 서버url
            headers: { // Http header
                'X-CSRFTOKEN': '{{ csrf_token }}'
            },
            dataType: 'json', // 데이터 타입 (html, xml, json, text 등등)
            data: postdata,
            success: function(data) { // 결과 성공 콜백함수
                state = n
                tab = '#tab_'+state;
                tabcontent = '#tabcontent_'+state;

                $('#tab_1,#tab_2').removeClass('active')
                $(tab).addClass('active')

                $('#tabcontent_1,#tabcontent_2').attr('hidden','')
                $(tabcontent).removeAttr('hidden','')

                if (state == '1'){
                    google.charts.load('current', {packages: ['corechart', 'bar']});
                    google.charts.setOnLoadCallback(drawAxisTickColors);
                }

                return;
            },
            error: function(request, status, error) { // 결과 에러 콜백함수
                console.log(error)
            }
        })
    }

    // 그래프 기능
    function drawAxisTickColors() {

        var data = google.visualization.arrayToDataTable([
            ['증상', '해독지수', {role:'style'}],
            ['식욕', Number('{{third_tab.appetite|cut:"0."}}'),'color:#6666FF; width:6; opacity:0.7;'],
            ['소화', Number('{{third_tab.digestion|cut:"0."}}'),'color:#006699; width:6; opacity:0.7;'],
            ['대변', Number('{{third_tab.foo|cut:"0."}}'),'color:#669966; width:6; opacity:0.7;'],
            ['소변', Number('{{third_tab.fee|cut:"0."}}'),'color:#66FF66; width:6; opacity:0.7;'],
            ['수면', Number('{{third_tab.sleep|cut:"0."}}'),'color:#663366; width:6; opacity:0.7;'],
            ['스트레스', Number('{{third_tab.stress|cut:"0."}}'),'color:#663399; width:6; opacity:0.7;'],
            ['땀', Number('{{third_tab.sweat|cut:"0."}}'),'color:#6633FF; width:6; opacity:0.7;'],
            ['수족냉증', Number('{{third_tab.coldhand|cut:"0."}}'),'color:#66FFFF; width:6; opacity:0.7;'],
            ['손발저림', Number('{{third_tab.hand_numb|cut:"0."}}'),'color:#006699; width:6; opacity:0.7;'],
            ['두통', Number('{{third_tab.headache|cut:"0."}}'),'color:#FFCC99; width:6; opacity:0.7;'],
            ['어지러움', Number('{{third_tab.whirl|cut:"0."}}'),'color:#FF33CC; width:6; opacity:0.7;'],
            ['부종', Number('{{third_tab.tumepy|cut:"0."}}'),'color:#FF9900; width:6; opacity:0.7;'],
            ['갈증', Number('{{third_tab.thrist|cut:"0."}}'),'color:#FF3300; width:6; opacity:0.7;'],
            ['경향통', Number('{{third_tab.shoulder_pain|cut:"0."}}'),'color:#66FFCC; width:6; opacity:0.7;'],
            ['가슴답답', Number('{{third_tab.chest|cut:"0."}}'),'color:#33CC99; width:6; opacity:0.7;'],
            ['심계', Number('{{third_tab.heart_pain|cut:"0."}}'),'color:#FF3399; width:6; opacity:0.7;'],
            ['상열감', Number('{{third_tab.anxious|cut:"0."}}'),'color:#993300; width:6; opacity:0.7;'],
            ['만성피로', Number('{{third_tab.fatigue|cut:"0."}}'),'color:#CCFF66; width:6; opacity:0.7;'],
            ['생리통', Number('{{third_tab.menstruation_pain|cut:"0."}}'),'color:#CCCCCC; width:6; opacity:0.7;'],
            ['생리주기', Number('{{third_tab.menstruation_period|cut:"0."}}'),'color:#FFCCCC; width:6; opacity:0.7;'],
    ]);

    var options = {
        width: '85%',
        height : '100%',
        left:'0',
      chartArea: {
        width: '85%',
        height:'85%',
        backgroundColor:'white',
        padding:'0',
      },
      bar:{
        groupWidth: "80%",
      },
      legend:'none',
      backgroundColor:'transparent',
      hAxis: {
        viewWindowMode:'explicit',
        viewWindow: {
            min: 0,
            max: 100
        },
        backgroundColor:'white',
        minValue: 0,
        textStyle: {
          bold: false,
          fontSize: 10,
          color: 'black',
        },
        titleTextStyle: {
          bold: false,
          fontSize: 18,
          color: 'black'
        }
      },
      vAxis: {
        backgroundColor:'white',
        textStyle: {
          fontSize: 12,
          bold: false,
          color: 'black'
        },
        titleTextStyle: {
          fontSize: 14,
          bold: false,
          color: 'black'
        }
      }
    };
    var chart = new google.visualization.BarChart(document.getElementById('chart_div'));
    chart.draw(data, options);
    $('#chart_div > div').addClass('col-sm-12')
    $('#chart_div div[dir="ltr"]').css('width','100%')
    $('#chart_div svg').addClass('col-sm-12')
  };

    //프린트 기능
    $('#printbtn').click(function() {
        var origin_width = $('#result_data').css('width')
        var origin_height = $('#result_data').css('height')
        var origin_padding = $('#result_data').css('padding')

        window.onbeforeprint = function () {

            $('section > div').removeClass('container')

            $('#printnotarea1').attr('hidden','');
            $('div #printnotarea1').attr('hidden','');

            $('#printnotarea2').attr('hidden','');

            $('#tab-menu').attr('hidden','');
            $('nav').hide();
            $('#no_service_area_hide').attr('hidden','');

            $('#service_area > div > div').removeClass('text-light bg-primary');
            $('#service_area > div > div').css('border','1px solid black');

            $('#print_service_area').removeClass('col-sm-7');
            $('#print_service_area').css('width','100%');

            $('#printarea #hidden_title').removeAttr('hidden','')
            $('#printarea #result_data').removeClass('card')
            $('#printarea #result_data').css({'width':'100%', 'height':'100%','overflow':'visible','padding':''});

            $('.result_2 table').css({'font-size':'.5em'})

            google.charts.load('current', {packages: ['corechart', 'bar']});
            google.charts.setOnLoadCallback(drawAxisTickColors);
        }

        window.onafterprint = function () {
            google.charts.load('current', {packages: ['corechart', 'bar']});
            google.charts.setOnLoadCallback(drawAxisTickColors);

            $('section > div').addClass('container')

            $('#printnotarea1').removeAttr('hidden','')
            $('div #printnotarea1').removeAttr('hidden','')

            $('#printnotarea2').removeAttr('hidden','')

            $('#tab-menu').removeAttr('hidden','')
            $('nav').show()
            $('#no_service_area_hide').removeAttr('hidden','');

            $('#service_area > div > div').addClass('text-light bg-primary');
            $('#service_area > div > div').css('border','0px');

            $('#print_service_area').addClass('col-sm-7');
            $('#print_service_area').css('width','');
      

            $('#printarea #hidden_title').attr('hidden','')
            $('#printarea #result_data').addClass('card')
            $('#printarea #result_data').css({'width':origin_width,'height':origin_height,'overflow':'scroll','padding':origin_padding});

            $('.result_2 table').css({'font-size':'.8em'})
        }

        window.print();
        location.reload();
    })


    // 처방 영역과 미처방영역 add & delete(id = 공통이름_고유번호)
    function move_event(id) {
        var target = document.getElementById(String(id));
        var target_box = target.closest('.area').getAttribute('id')
        var jqueryid = "#"+id
        var jqueryparentsid = "#"+id+"_b"

        //클릭한게 처방 영역에 있으면 미처방영역으로 옮김.
        if (target_box == 'service_area') {
            var lastnum = $('#service_area > div').last().attr('id').slice(-1)
            var firstnum = $('#service_area > div').first().attr('id').slice(-1)

            $(jqueryid).removeClass('bg-primary text-light')
            $(jqueryid).addClass('bg-light text-dark')
            $("#no_service_area "+jqueryparentsid).append(target)

        }
        //클릭한게 미처방 영역에 있으면 처방 영역으로 옮김.
        else if (target_box == 'no_service_area') {
            $(jqueryid).removeClass('bg-light text-dark')
            $(jqueryid).addClass('bg-primary text-light')
            $("#service_area "+jqueryparentsid).append(target)
        }       
        life_style_recommend() 
    } 

    //종료 버튼
    $('#prescription_complete_btn').click(function(){
        $('#expert_data').trigger('click');
    }) 

    //예상질환 함수
    function get_result_info(){

        var textarea_str = ''
        var area_h = 0

        var tongue_color = "{{first_tab.tongue_color}}"
        var ecchymosis = "{{first_tab.ecchymosis}}"
        var scallop = "{{first_tab.scallop}}"
        var heart_crack = "{{first_tab.heart_crack}}"
        var large_intenstines_coating = "{{first_tab.large_intenstines_coating}}"
        var stomach_coating = "{{first_tab.stomach_coating}}"
        var left_lung_coating = "{{first_tab.left_lung_coating}}"
        var ecchymosis ="{{first_tab.ecchymosis}}"
        var tongue_tip_redness = "{{first_tab.tongue_tip_redness}}"


        if (tongue_color==1){
            textarea_str = textarea_str + "담백설로 허로가 예상됩니다.\n";
            area_h += 1}
        else if (tongue_color==2){
            textarea_str = textarea_str + "홍설로 열증이 예상됩니다.\n";
            area_h += 1}
        else if (tongue_color==3){
            textarea_str = textarea_str + "강설로 어혈이 예상됩니다.\n";
            area_h += 1}
        else if (tongue_color==4){
            textarea_str = textarea_str + "자설로 어혈이 예상됩니다.\n";
            area_h += 1}

        if (ecchymosis==1){
            textarea_str = textarea_str + "어반이 있어 어혈이 예상됩니다.\n";
            area_h += 1}

        if (scallop==1){
            textarea_str = textarea_str + "치흔이 있어 허로가 예상됩니다.\n";
            area_h += 1}

        if (heart_crack==1){
            textarea_str = textarea_str + "심장 영역에 설열이 있어 심장질환이 예상됩니다.\n";
            area_h += 1
        }

        if (large_intenstines_coating==2){
            textarea_str = textarea_str + "대장 영역에 백태가 있어 과민성대장이 예상됩니다.\n";
            area_h += 1}
        else if (large_intenstines_coating==3){
            textarea_str = textarea_str + "대장 영역에 황태가 있어 과민성대장이 예상됩니다.\n";
            area_h += 1}
            
        if (ecchymosis==1){
            textarea_str = textarea_str + "폐 영역에 설반이 있어 알러지가 예상됩니다.\n";
            area_h += 1}
        
        if (tongue_tip_redness == 1){
            textarea_str = textarea_str + "설첨 홍이 있어 심장질환이 예상됩니다.\n";
            area_h += 1
        }

        if (textarea_str.length == 0){
            textarea_str = textarea_str + "설진에서 이상이 존재하지 않습니다.\n";
            area_h += 1}
        $('#predict_result_area').val(textarea_str);
        
        var area_height = String(31 * area_h)+'px'
        $('#predict_result_area').css('height',area_height)
}

function life_style_recommend() {
    var recommendation = (document.getElementById('service_area')).getElementsByClassName('recommendation')
    var result_text = ''
    var area_h = 0

    for (i=0;i<recommendation.length;i++){
        var text = recommendation[i].innerHTML

        if (text.indexOf('청일수') > 0 ) {
            result_text += '- 청일수 : 수분 섭취와 수분 대사가 중요합니다. 평소 물을 충분히 섭취해 관리 해주세요. \n'
            area_h += 1
        }
        if (text.indexOf('청이장') > 0 ) {
            result_text += '- 청이장 : 평소 식이 섬유의 섭취가 부족하고, 장내 균형이 필요한 상태입니다.  \n'
            area_h += 1
        }
        if (text.indexOf('청삼혈') > 0 ) {
            result_text += '- 청삼혈 : 체지방의 대사기능이 떨어지므로, 기름진 음식을 줄이고 근육량을 키우도록 해야 합니다. \n'
            area_h += 1
        }
        if (text.indexOf('청사심') > 0 ) {
            result_text += '- 청사심 : 평소 스트레스 관리에 좀 더 신경을 쓸 필요가 있습니다. 스마트폰 사용을 줄이고, 시간을 내어 안정과 휴식을 위한 여가 시간을 확보하도록 하세요. \n'
            area_h += 1
        }
        if (text.indexOf('청오식') > 0 ) {
            result_text += '- 청오식 : 영양의 불균형이 우려됩니다. 좋아하는 음식만 드시기 보다는 단백질과 탄수화물, 무기질과 비타민이 포함된 균형 잡힌 식단이 필요합니다. \n'
            area_h += 1
        }
        if (text.indexOf('청육행') > 0 ) {
            result_text += '- 청육행 : 체내 순환이 떨어집니다. 규칙적인 운동과 스트레칭 등 몸을 많이 움직이도록 하고, 필요한 경우 침 치료나 마사지도 도움이 됩니다. \n'
            area_h += 1
        }
        if (text.indexOf('청칠위') > 0 ) {
            result_text += '- 청칠위 : 소화기능이 많이 떨어져 있는 상태이므로, 꼭꼭씹어 천천히 먹는 습관을 갖도록 하며, 인스턴트 식품 이나 가공 식품, 색소와 방부제가 많은 식품을 멀리해야 합니다. \n'
            area_h += 1
        }
    }
    $('#life_style_recommend').val(result_text)

    var area_height = String(30.5 * area_h)+'px'
    $('#life_style_recommend').css('height',area_height)
}

</script>
{% endblock %}